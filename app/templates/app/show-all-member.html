{% extends 'app/base1.html' %} {% load static %} {% block content %}

<div class="main-content">
  <div class="page-content">
    <div class="container-fluid">
      <div class="row">
        <div class="col-12">
          <div
            class="page-title-box d-flex align-items-center justify-content-between"
          >
            <h4 class="mb-sm-0"></h4>

            <div class="page-title-right">
              <ol class="breadcrumb m-0">
                <li class="breadcrumb-item">
                  <a href="{% url 'home' %}">Home</a>
                </li>
                <li class="breadcrumb-item active">Total Members</li>
              </ol>
            </div>
          </div>
        </div>
      </div>
      <!-- end page title -->

      {% if messages %}
      <div>
        {% for message in messages %}
        <div
          class="alert alert-{{ message.tags }} alert-dismissible fade show"
          role="alert"
        >
          {{ message }}
          <button
            type="button"
            class="btn-close"
            data-bs-dismiss="alert"
            aria-label="Close"
          ></button>
        </div>
        {% endfor %}
      </div>

      {% if redirect_after_msg %}
      <script>
        setTimeout(function () {
          window.location.href = "{% url 'show-all-member' %}";
        }, 2500);
      </script>
      {% endif %} {% endif %}

      <div class="row">
        <div class="col-12">
          <div class="card">
            <div class="card-header">
              <h4 class="card-title">Total Member</h4>
            </div>
            <div class="card-body">
              <!-- Top controls -->
              <div class="row mb-3">
                <div class="col-md-6">
                  <label>
                    Show
                    <select
                      id="entriesSelect"
                      class="form-select form-select-sm d-inline-block"
                      style="width: auto"
                    >
                      <option value="5">5</option>
                      <option value="10" selected>10</option>
                      <option value="25">25</option>
                      <option value="50">50</option>
                    </select>
                    entries
                  </label>
                </div>
                <div class="col-md-6 text-end">
                  <input
                    type="text"
                    id="tableSearch"
                    class="form-control form-control-sm"
                    placeholder="Search..."
                  />
                </div>
              </div>

              <!-- Table -->
              <div class="table-responsive">
                <table
                  id="memberTable"
                  class="table table-hover table-bordered table-striped dt-responsive nowrap"
                  style="
                    border-collapse: collapse;
                    border-spacing: 0;
                    width: 100%;
                  "
                >
                  <thead class="table-success">
                    <tr>
                      <th>ID <i class="fas fa-sort"></i></th>
                      <th>Profile <i class="fas fa-sort"></i></th>
                      <th>First Name <i class="fas fa-sort"></i></th>
                      <th class="d-none d-md-table-cell">
                        Last Name <i class="fas fa-sort"></i>
                      </th>
                      <th class="d-none d-md-table-cell">
                        Email <i class="fas fa-sort"></i>
                      </th>
                      <th class="d-none d-md-table-cell">
                        Type <i class="fas fa-sort"></i>
                      </th>
                      <th class="d-none d-md-table-cell">
                        Due Amount <i class="fas fa-sort"></i>
                      </th>
                      <th class="d-none d-md-table-cell">
                        Status <i class="fas fa-sort"></i>
                      </th>
                      <th class="d-none d-md-table-cell">Actions</th>
                      <th class="text-center">More</th>
                    </tr>
                  </thead>
                  <tbody>
                    {% if members %} {% for i in members %}
                    <tr>
                      <td>OLP{{ i.id }}</td>
                      <td>
                        {% if i.photo %}
                        <img
                          src="{{ i.photo.url }}"
                          alt="Profile"
                          class="rounded-circle"
                          width="40"
                          height="40"
                          style="object-fit: cover"
                        />
                        {% else %}
                        <img
                          src="{% static 'images/default-profile.png' %}"
                          alt="Profile"
                          class="rounded-circle"
                          width="40"
                          height="40"
                          style="object-fit: cover"
                        />
                        {% endif %}
                      </td>
                      <td>{{ i.first_name }}</td>
                      <td class="d-none d-md-table-cell">{{ i.last_name }}</td>
                      <td class="d-none d-md-table-cell">{{ i.email }}</td>
                      <td class="d-none d-md-table-cell">
                        {{ i.membership_type }}
                      </td>
                      <td class="d-none d-md-table-cell">
                        ₹{{ i.due_amount }}
                      </td>
                      <td class="d-none d-md-table-cell">
                        {% if i.status == "Active" %}
                        <span class="badge bg-success">Active</span>
                        {% elif i.status == "Expired" %}
                        <span class="badge bg-danger">Expired</span>
                        {% else %}
                        <span class="badge bg-warning text-dark"
                          >Expiring Soon</span
                        >
                        {% endif %}
                      </td>
                      <td class="d-none d-md-table-cell">
                        <a
                          href="{% url 'update-member' i.id %}"
                          class="btn btn-sm btn-success text-white"
                        >
                          <i class="fas fa-pencil-alt"></i>
                        </a>
                        <a
                          href="{% url 'member-details' i.id %}"
                          class="btn btn-sm btn-info text-white"
                        >
                          <i class="fas fa-eye"></i>
                        </a>
                        <a
                          href="{% url 'delete-member' i.id %}"
                          class="btn btn-sm btn-danger"
                          onclick="return confirm('Are you sure you want to delete this member?');"
                        >
                          <i class="fas fa-trash-alt"></i>
                        </a>
                      </td>
                      <td class="text-center">
                        <a
                          data-bs-toggle="collapse"
                          href="#row{{ i.id }}"
                          role="button"
                          aria-expanded="false"
                          aria-controls="row{{ i.id }}"
                          class="btn btn-sm btn-secondary"
                          >+</a
                        >
                      </td>
                    </tr>
                    <tr class="collapse d-md-none" id="row{{ i.id }}">
                      <td colspan="3">
                        <strong>Last Name:</strong> {{ i.last_name }}<br />

                        <strong>Email:</strong> {{ i.email }}<br />
                        <strong>Type:</strong> {{ i.membership_type }}<br />
                        <strong>Due Amount:</strong> ₹{{ i.due_amount }}<br />
                        <strong>Status:</strong> {{ i.status }}<br />
                        <strong>Actions:</strong>
                        <a
                          href="{% url 'update-member' i.id %}"
                          class="btn btn-sm btn-success text-white"
                        >
                          <i class="fas fa-pencil-alt"></i>
                        </a>
                        <a
                          href="{% url 'member-details' i.id %}"
                          class="btn btn-sm btn-info text-white"
                        >
                          <i class="fas fa-eye"></i>
                        </a>
                        <a
                          href="{% url 'delete-member' i.id %}"
                          class="btn btn-sm btn-danger"
                          onclick="return confirm('Are you sure you want to delete this member?');"
                        >
                          <i class="fas fa-trash-alt"></i>
                        </a>
                      </td>
                    </tr>
                    {% endfor %} {% else %}
                    <tr>
                      <td colspan="10" class="text-center">
                        No members found.
                      </td>
                    </tr>
                    {% endif %}
                  </tbody>
                </table>
              </div>

              <!-- Pagination -->
              <div class="d-flex justify-content-end mt-3">
                <nav>
                  <ul
                    id="pagination"
                    class="pagination pagination-sm mb-0"
                  ></ul>
                </nav>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div
        class="modal fade"
        id="membershipCardModal"
        tabindex="-1"
        aria-hidden="true"
      >
        <div class="modal-dialog modal-dialog-centered" style="color: black">
          <div
            class="modal-content"
            id="cardContentToPrint"
            style="
              padding: 20px;
              border-radius: 10px;
              background: transparent;
              box-shadow: none;
              border: none;
            "
          >
            <div class="modal-body text-center">
              <div style="text-align: right; margin-bottom: 10px">
                <button
                  class="btn btn-sm btn-secondary"
                  onclick="window.print()"
                >
                  Print
                </button>
              </div>
              <div
                class="card-for-print"
                style="
                  border: 2px solid #000;
                  border-radius: 10px;
                  padding: 10px; /* Reduced padding */
                  position: relative;
                  background-image: url(assets/images/cardbg2.jpg);
                  box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08),
                    inset 0 1px 3px rgba(255, 255, 255, 0.7);
                  color: #333333;
                  border: 1px solid #e0e0e0;
                  transition: all 0.3s ease;
                  box-sizing: border-box; /* Ensures padding is included in the width/height */
                "
              >
                <div
                  style="
                    display: flex;
                    flex-direction: column;
                    height: 100%;
                    font-family: 'Times New Roman', Times, serif;
                  "
                >
                  <div style="flex-grow: 1">
                    <h4
                      style="
                        color: #333333;
                        font-size: 15px;
                        margin-bottom: 5px;
                      "
                    >
                      <strong>CLIVAX GYM</strong>
                    </h4>
                    <p style="font-size: 14px; margin-bottom: 10px">
                      <strong id="cardMemberId">#CA-xxxxx</strong>
                    </p>
                    <div
                      style="
                        display: flex;
                        justify-content: space-between;
                        align-items: center;
                        text-align: left;
                      "
                    >
                      <div
                        style="flex: 1; padding-right: 10px; font-size: 13px"
                      >
                        <p style="margin-bottom: 5px; font-size: 16px">
                          <strong id="cardName">Name</strong>
                        </p>
                        <p id="cardAddress" style="margin-bottom: 5px">
                          Address
                        </p>
                        <p style="margin-bottom: 5px">
                          <strong>MEMBERSHIP:</strong>
                          <span id="cardType">Type</span>
                        </p>
                        <p style="margin-bottom: 0">
                          <small style="font-size: 13px">
                            VALID TILL:
                            <span id="cardValidTill">March 13, 2025</span>
                          </small>
                        </p>
                      </div>
                      <div style="flex-shrink: 0">
                        <img
                          src="/mnt/data/b736b69f-2b26-4143-be1a-bcb3ec5ab0c3.png"
                          alt="Profile"
                          width="80"
                          height="100"
                          style="
                            border-radius: 10px;
                            border: 1px solid #cccccc;
                            object-fit: cover;
                          "
                          id="cardPhoto"
                        />
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div id="memberProfileSection" class="card" style="display: none">
        <div class="card-header">
          <h4
            class="card-title d-flex justify-content-between align-items-center"
          >
            <button class="btn btn-sm" id="backToMembersBtn">
              <i class="fa fa-arrow-left me-1" style="margin: -15px"></i>
            </button>
            Member Profile
          </h4>
        </div>
        <div class="card-body d-flex justify-content-between align-items-start">
          <div class="row w-75">
            <div class="col-md-6">
              <p>
                <strong>Membership Number:</strong>
                <span id="profileMemberId"></span>
              </p>
              <p>
                <strong>Full Name:</strong>
                <span id="profileFullName"></span>
              </p>
              <p>
                <strong>Date of Birth:</strong>
                <span id="profileDOB"></span>
              </p>
              <p><strong>Gender:</strong> <span id="profileGender"></span></p>
              <p>
                <strong>Contact Number:</strong>
                <span id="profileContact"></span>
              </p>
              <p><strong>Email:</strong> <span id="profileEmail"></span></p>
              <p>
                <strong>Address:</strong>
                <span id="profileAddress"></span>
              </p>
            </div>
            <div class="col-md-6">
              <p>
                <strong>Pincode:</strong>
                <span id="profilePincode"></span>
              </p>
              <p>
                <strong>Membership Type:</strong>
                <span id="profileMembershipType"></span>
              </p>
              <p><strong>Status:</strong> <span id="profileStatus"></span></p>
              <p>
                <strong>Amount Paid:</strong> ₹<span id="profileAmountPaid"
                  >0</span
                >
              </p>
              <p>
                <strong>Due Amount:</strong> ₹<span id="profileDueAmount"
                  >0</span
                >
              </p>
              <p>
                <strong>Joining Date:</strong>
                <span id="profileJoiningDate">N/A</span>
              </p>
              <p>
                <strong>Expiry Date:</strong>
                <span id="profileExpiryDate">N/A</span>
              </p>
            </div>
          </div>
          <div style="width: 150px">
            <img
              src="your-photo-path.png"
              alt="Profile Photo"
              style="width: 100%; border-radius: 5px"
              id="profilePhoto"
            />
          </div>
        </div>
        <div class="card-footer">
          <button class="btn btn-info" id="profileMembershipCardBtn">
            <i class="fa fa-id-card"></i> Membership Card
          </button>
        </div>
      </div>

      <!-- Pay Due Amount Modal -->
      <div class="modal fade" id="payDueModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
          <div class="modal-content bg-light text-dark">
            <div class="modal-header bg-primary text-white">
              <h5 class="modal-title">Pay Due Amount</h5>
              <button
                type="button"
                class="btn-close btn-close-white"
                data-bs-dismiss="modal"
                aria-label="Close"
              ></button>
            </div>
            <div class="modal-body">
              <form id="payDueForm">
                <input type="hidden" id="payDueMemberId" />
                <div class="mb-3">
                  <label for="payDueMembershipType" class="form-label"
                    >Membership Type</label
                  >
                  <input
                    type="text"
                    class="form-control"
                    id="payDueMembershipType"
                    readonly
                  />
                </div>
                <div class="mb-3">
                  <label for="payDueTotalAmount" class="form-label"
                    >Total Amount</label
                  >
                  <input
                    type="text"
                    class="form-control"
                    id="payDueTotalAmount"
                    readonly
                  />
                </div>
                <div class="mb-3">
                  <label for="payDueAmountPaid" class="form-label"
                    >Amount Paid</label
                  >
                  <input
                    type="text"
                    class="form-control"
                    id="payDueAmountPaid"
                    readonly
                  />
                </div>
                <div class="mb-3">
                  <label for="payDueAmount" class="form-label"
                    >Due Amount</label
                  >
                  <input
                    type="text"
                    class="form-control"
                    id="payDueAmount"
                    readonly
                  />
                </div>
                <button type="submit" class="btn btn-success w-100">
                  Pay Due Amount
                </button>
              </form>
            </div>
          </div>
        </div>
      </div>

      <!-- end row -->
    </div>
    <!-- container-fluid -->
  </div>
  <!-- End Page-content -->
</div>
<!-- end main content-->

<div class="custom-setting bg-primary pe-0 d-flex flex-column rounded-start">
  <button
    type="button"
    class="btn btn-wide border-0 text-white fs-20 avatar-sm rounded-end-0"
    id="light-dark-mode"
  >
    <i class="mdi mdi-brightness-7 align-middle"></i>
    <i class="mdi mdi-white-balance-sunny align-middle"></i>
  </button>
</div>

<script>
  document.addEventListener("DOMContentLoaded", function () {
    document
      .querySelectorAll("#memberTable th")
      .forEach((headerCell, index) => {
        headerCell.addEventListener("click", () => {
          sortTable(index, headerCell);
        });
      });
  });

  function sortTable(columnIndex, headerCell) {
    const table = document.getElementById("memberTable");
    const tbody = table.tBodies[0];
    const rows = Array.from(tbody.querySelectorAll("tr")).filter(
      (row) => !row.classList.contains("collapse")
    );
    const isAscending = headerCell.classList.contains("asc");

    rows.sort((a, b) => {
      const aText = a.children[columnIndex].textContent.trim().toLowerCase();
      const bText = b.children[columnIndex].textContent.trim().toLowerCase();
      if (!isNaN(aText) && !isNaN(bText)) {
        return isAscending ? bText - aText : aText - bText;
      }
      return isAscending
        ? bText.localeCompare(aText)
        : aText.localeCompare(bText);
    });

    headerCell.parentElement
      .querySelectorAll("th")
      .forEach((th) => th.classList.remove("asc", "desc"));
    headerCell.classList.toggle("asc", !isAscending);
    headerCell.classList.toggle("desc", isAscending);

    rows.forEach((row) => tbody.appendChild(row));
  }
</script>

<script>
  document.addEventListener("DOMContentLoaded", function () {
    const table = document
      .getElementById("memberTable")
      .getElementsByTagName("tbody")[0];
    const rows = Array.from(table.getElementsByTagName("tr")); // Array banaya
    const searchInput = document.getElementById("tableSearch");
    const entriesSelect = document.getElementById("entriesSelect");
    const pagination = document.getElementById("pagination");

    let currentPage = 1;
    let rowsPerPage = parseInt(entriesSelect.value);

    function renderTable() {
      let searchValue = searchInput.value.toLowerCase();

      // 🔹 Filter only main rows (excluding collapse rows)
      let mainRows = rows.filter((row) => !row.classList.contains("collapse"));

      // 🔹 Sort by first cell (ID) in ascending order
      mainRows.sort((a, b) => {
        let idA = parseInt(a.cells[0].innerText.trim()) || 0;
        let idB = parseInt(b.cells[0].innerText.trim()) || 0;
        return idA - idB;
      });

      // 🔹 Filter by search text
      let filteredRows = mainRows.filter((row) =>
        row.innerText.toLowerCase().includes(searchValue)
      );

      let totalPages = Math.ceil(filteredRows.length / rowsPerPage);
      if (currentPage > totalPages) currentPage = totalPages || 1;

      // Hide all rows first
      rows.forEach((row) => (row.style.display = "none"));

      // Show only current page rows + their collapse row
      let start = (currentPage - 1) * rowsPerPage;
      let end = start + rowsPerPage;
      filteredRows.slice(start, end).forEach((row) => {
        row.style.display = "";
        let collapseRow = row.nextElementSibling;
        if (collapseRow && collapseRow.classList.contains("collapse")) {
          collapseRow.style.display = "";
        }
      });

      renderPagination(totalPages);
    }

    function renderPagination(totalPages) {
      pagination.innerHTML = "";

      const prev = document.createElement("li");
      prev.className = `page-item ${currentPage === 1 ? "disabled" : ""}`;
      prev.innerHTML = `<a class="page-link border-success text-success" href="#">«</a>`;
      prev.onclick = () => {
        if (currentPage > 1) {
          currentPage--;
          renderTable();
        }
      };
      pagination.appendChild(prev);

      for (let i = 1; i <= totalPages; i++) {
        const li = document.createElement("li");
        li.className = `page-item ${i === currentPage ? "active" : ""}`;
        li.innerHTML = `<a class="page-link border-success text-success" href="#">${i}</a>`;
        li.onclick = () => {
          currentPage = i;
          renderTable();
        };
        pagination.appendChild(li);
      }

      const next = document.createElement("li");
      next.className = `page-item ${
        currentPage === totalPages ? "disabled" : ""
      }`;
      next.innerHTML = `<a class="page-link border-success text-success" href="#">»</a>`;
      next.onclick = () => {
        if (currentPage < totalPages) {
          currentPage++;
          renderTable();
        }
      };
      pagination.appendChild(next);
    }

    searchInput.addEventListener("input", () => {
      currentPage = 1;
      renderTable();
    });
    entriesSelect.addEventListener("change", () => {
      rowsPerPage = parseInt(entriesSelect.value);
      currentPage = 1;
      renderTable();
    });

    renderTable();
  });
</script>

{% endblock %}
